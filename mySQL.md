TCL  事务

事务的ACID属性

A Atomicity[ætəˈmɪsəti] 事务不可分割  都发 都不发  原子性

C Consisteny[kənˈsɪstənsi] 事务使数据库从一个一致性状态 切换到另一个一致性状态 一致性

I  Isolcation[ˌaɪsəˈleɪʃn]  事务之间不能干扰  隔离级别  隔离性

D durability[dərəˈbɪlɪti] 事务一旦提交 对数据库的改变就是永久性的   持久性



事务创建

​		隐式事务 ：事务没有明显的开启和结束的标记

​		insert  update delete

​		显示事务：

​		set autocommit =0；开启事务

​		sql语句

​		rollback||commit ; 结束事务



事务隔离级别

​		事务间不采用隔离机制

​				更新丢失：后完成事务覆盖更新原事务

​				脏读：读取未提交的字段，读到临时且无效的字段   针对更新

​				不可重复度：重复度值不同

​				幻读：重复读取数据 会多读出数据  针对插入

​		

​		设置事务间的隔离级别

​			  查看隔离级别：SELECT @@tx_isolation

​              设置当前连接隔离级别： set transaction isolation  level  read commited;

​			  设置全局隔离级别： set global  transaction isolation  level read  committed;		



视图

​		保存sql

​		create view 视图名

​		as

​		复杂查询



变量

​		系统变量（系统提供）：

​				全局变量 show global variables   可模糊查询

​				会话变量 show session variables  可模糊查询  

​								查看指定值 select @@global| session.变量名

​								设置 set  @@global| session.变量名=值

​				变更后不能跨重启，重启无效，重启有效需要 修改配置文件



​		自定义变量

​				用户变量：针对当前会话（链接）有效

​						声明初始化  set @用户变量名=值

​											 set @用户变量名:=值

​											 select @用户变量名:=值

​						赋值

​								select count(*) into @用户变量名  from 表

​				局部变量

​						声明：  declare  变量名  类型；

​									 declare  变量名   Default  值；

​						使用：  只能在BEGIN END中  

​											 set 局部变量名=值

​											 set 局部变量名:=值

​											select @局部变量名:=值

​											select count(*) into 局部变量名  from 表



存储过程和函数

​		存储过程：

​				一组SQL    提高代码重用性   简化操作  减少编译次数  减少连接次数  提高效率

​				语法：

​						CREATE PROCEDURE 存储过程名（参数列表）

​						BEGIN

​				 					存储过程体（一组合法的SQL语句）

​						END

​				参数列表

​						参数模式  参数名            参数类型

​						IN              stuname        VARCHAR(20)



​				参数模式

​						IN   该参数可作为输入，需要调用方传入值

​            			OUT  该参数可作为输出，该参数可作为返回值

​						INOUT  作为输入&输出，该参数需要传入值，又可以返回值



​				存储过程体

​						SQL语句以分号结束

​						存储过程结尾可以使用DELIMITER 重新设置

​						语法：

​						DELIMITER 结束标记 ：  DELIMITER $

​				调用：

​						call  存储过程名称（实参列表）



​		函数：

​				不同与存储过程0个或多个返回，函数有且只有一个返回

​				存储过程：批量增删改

​				函数：处理数据，处理完成返回结果

​				

​				语法：

​						CREATE FUNCTION 	函数名（参数列表） RETURNS  返回类型

​						BEGIN

​									函数体

​						END

​						参数列表 包含参数名 参数类型



​				调用：

​						SELECT 函数名（参数列表）

流程控制结构	

​		顺序结构

​		分支结构

​				分支结构IF函数

​				分支结构CASE

​				分支结构IF结构

​		循环结构

​				while、loop、repeat







非DBA  和JAVA开发相关的

JAVA工程师写出高性能SQL

1、mysql 架构介绍

2、索引优化分析  相关crud 写sql 查sql   索引相关

3、查询截取分析 （查找相关慢的sql,定位sql,将sql重写或者改造）

4、锁机制（行锁 表锁）

5、主从复制

​				

### mysql架构介绍

mysql简介 

mysqlLinux安装

​		rpm -ivh Mysql.rpm

​		自启mysql chkconfig mysql on

​		数据库存在硬盘的 /var/lib/mysql

​		/var/lib/mysql 数据库文件存放路径

​		/usr/share/mysql 配置文件目录

​		/usr/bin 相关命令目录

​		/etc/init.d/mysql 启停相关脚本



Mysql配置文件

​		二进制日志文件:log-bin  用于主从复制

​		错误日志:log-error 默认关闭 记录严重警告和错误信息，每次启动和关闭的详细信息等

​		查询日志:log 默认关闭 记录查询的sql语句 开启会强敌mysql整体性能

​		数据文件

​				frm文件  存放表结构

​				myd文件  存放表数据

​				myi文件   查找表数据的索引







Mysql逻辑架构

​		Connectors连接层

​		Connection Pool 连接池

​		Management Services& Utilities 工具 

​		SQL Interface

​		Parser  转换

​		Optimizer 优化

​		Caches&Buffers 缓存

​		Pluggable Storage Engines 可拔插存储引擎

​		File system 

​		File&Logs

​		插件式的 存储引擎框架将  查询处理   和其他的系统任务以及数据的   存储提取相分离



​		连接层

​				包含客户端和连接服务，包含本地sock通信和大多数基于客户端工具实现的类似于tcp/ip的通信

​				主要完成一些类似于连接处理、授权认证、及相关的安全方案

​				该层引入线程池的概念，为通过认证安全接入的客户端提供线程

​				在该层伤可以实现基于SSL的安全连接，服务器也会为安全接入的每个客户端验证它具有的操作权限



​		服务层

​				完成大多服功能，如SQL接口并完成缓存的查询，SQL的分析和优化及部分内置函数的执行

​				实现跨存储引擎的功能 如过程、函数等等

​				该层内，服务器解析查询并创建相应的内部解析树，并对起完成相应的优化如确定查询表的顺序，是否  		利用索引，最后生成相应的执行操作。如果select会查询内部缓存



​		引擎层

​				存储引擎层，负责Mysql中数据的存储和提取 服务器通过API和存储引擎进行通信

​		存储层

​				数据存储层，将数据存志在运行于裸设备的文件系统之上，并完成于存储引擎的交互

​		

mysql存储引擎

​				InnoDB、MyISAM

| 对比项   | MyISAM                                         | InnoDB                                                       |
| -------- | ---------------------------------------------- | ------------------------------------------------------------ |
| 主外键   | 不支持                                         | 支持                                                         |
| 事物     | 不支持                                         | 支持                                                         |
| 行表锁   | 表锁，一条记录也会锁住整个表，不适合高并发操作 | 行锁，操作时只锁一行，不对其他行有影响，适合高并发操作       |
| 缓存     | 只缓存索引，不缓存真实数据                     | 不仅仅缓存 索引还要缓存真实数据，对内存要求较高，而且内存大小对性能有决定性影响 |
| 表空间   | 小                                             | 大                                                           |
| 关注点   | 性能                                           | 事物                                                         |
| 默认安装 | Y                                              | Y                                                            |



​		



### 索引优化分析

性能下降SQL变慢

​		执行时间长、等待时间长

1. 查询语句写得烂
2. 索引失效  
   1. 单值索引
   2. 复合索引 
3. 关联查询太多join(设计缺陷或不得已的需求)
4. 服务器调优及各个参数设置（缓冲、线程数等）



常见通用Join查询

​		SQL执行顺序：手写、机读（从From开始）

​		七种 图

索引简介

​		定义：Index帮助MySQL高效获取数据的  数据结构

​					排好序的快速查找数据结构

​					索引影响where 后面的查找 和order by后面的排序   查找+排序

​					数据之外，数据库系统维护者满足特定查找算法的数据结构，这些数据结构以某种方式引用（指向）			数据，这样就可以在这些数据结构上基础上实现高级查找算法，这种数据结构就是索引。

​					索引不准

​					改数据还要要改索引

​					一般来说索引本身也很大，不可能全部存储在内存中，以索引文件的形式存储在磁盘上。

​					索引一般指B树（多路搜索树，不一定二叉）结构组织索引



​	优劣势：

​				提高检索效率降低数据库IO

​				降低排序成本  降低CPU消耗



​				索引也是一张表  保存主键与索引字段  占空间

​				提高查询速度的同时降低更新表速度  写操作数据的同时 还要更新索引

​				索引是删了建 建了删   不断优化



​	索引分类：

​				多建立复合索引、一张表最多建立五个索引

​				单值索引:一个索引包含一个列，一个表可以有多个索引

​				唯一索引： 索引列值必须唯一，允许空值

​				复合索引：一个索引包含多个列



   索引基本语法：



   mysql索引结构：

​				BTree索引  B树原理



​	哪些情况需要建立索引：

​				主键自动建立唯一索引

​				频繁作为查询条件的字段应该创建索引

​				查询中与其它标关联的字段，外键关系建立索引

​				频繁更新的字段不适合创建索引

​				Where条件里用不到的字段不创建索引

​				查询中排序的字段，排序字段如果通过索引访问大大提速

​				查询中统计或者分组字段

​				

​	哪些情况不需要建立索引：

​				表记录太少  500W以上要

​				经常增删改的表

​				数据重复且分布平均的表字段



性能分析

​	MySql Query Optimizer：MySQL 自带分析器

​			专门负责优化Select语句的优化器模块

​			功能:

​					通过计算分析统计信息 为客户端请求的Query提供最优执行计划

​					MySQL认为最优的  DBA不一定   最耗时间



​	MySql常见瓶颈

​			CPU:CPU饱和的时候一般发生在数据装入内存或者从磁盘读取数据的时候

​			IO：磁盘IO瓶颈发生在装入数据远大于内存容量

​			服务器硬件性能瓶颈：

​	

​	Explain 

​			模拟优化器执行SQL查询语句，从而知道Mysql如何处理你的SQL语句，分析你的查询语句或是表结构的性	能瓶颈。通过Explain  分析 SQL



索引优化

​	通过Explain 结果进行优化





### 查询截取分析

1. 慢查询的开启并捕获
2. explain+慢SQL分析
3. show profile 查询SQL在Mysql服务器中的执行细节和生命周期
4. SQL数据库服务器参数调优



查询优化

​	小表驱动大表

​	order by 关键字优化

​	group by 关键字优化

​	

​		

慢查询日志

​	日志记录、记录Mysql中响应时间超过阈值的SQL

​	cd /var/lib/mysql 可查看到具体日志记录

​	日志分析工具mysqldumpslow



批量数据脚本

​	存储过程+函数



Show profile

​	show profile cpu,block io for query Query_ID 查看指定Query_ID执行过程中CPU  和 IO情况



全局查询日志

​	开启功能后会在mysql库中的general_log中记录执行过的sql



### 锁机制

读锁：共享锁

写锁：排他锁

​	对表加读锁 写锁  



行锁

页锁

表锁

​	

### 主从复制

复制的基本原理

​		slave 从master读取binlog进行数据同步

​		步骤：

​				1、master将改变 记录到二进制文件（binary log）。这些记录过程叫做二进制日志事件 binary log 				events

​				2、slave 将master的 binary log events拷贝到它的中继日志（relay log）

​				3、slave 重放这些日志中的事件  将改变应用到自己的数据库  Mysql复制是异步且串行化

配置









